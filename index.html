<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>


    <title>SongNav</title>
</head>

<style>
    body{
        width: 100%;
        height: 100%;
        position: relative;
        overflow: hidden;
        padding: 0;
        margin: 0;

    }

    /*input.form-control{*/
        /*position:absolute;*/
        /*z-index: 1000;*/
    /*}*/

    /*.form-group{*/
        /*position: absolute;*/
        /*top: 7%;*/
        /*z-index: 1000;*/


    /*}*/


    nav {
        z-index: 1000000;
    }
    #container canvas{
        font: 12px Arial;
        color: white;

        position: relative;
        z-index: 1;
    }

</style>
<body>



        <script src="lib/three.js"></script>

        <script src="lib/Projector.js"></script>
        <script src="lib/CanvasRenderer.js"></script>
        <script src="lib/Detector.js"></script>
        <script src="lib/TrackballControls.js"></script>

        <script src="lib/stats.min.js"></script>

        <script type="x-shader/x-vertex" id="vertexshader">

			attribute float size;
			attribute vec3 customColor;

			varying vec3 vColor;

			void main() {

				vColor = customColor;

				vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );

				gl_PointSize = size * ( 300.0 / -mvPosition.z );

				gl_Position = projectionMatrix * mvPosition;

			}

		</script>

        <script type="x-shader/x-fragment" id="fragmentshader">

			uniform vec3 color;
			uniform sampler2D texture;

			varying vec3 vColor;

			void main() {

				gl_FragColor = vec4( color * vColor, 1.0 );

				gl_FragColor = gl_FragColor * texture2D( texture, gl_PointCoord );

				if ( gl_FragColor.a < ALPHATEST ) discard;

			}

		</script>


        <nav class="navbar navbar-inverse navbar-fixed-top" style="position: absolute; left:0; top:0">
            <div class="container-fluid">
                <div class="navbar-header">
                    <a class="navbar-brand" href="#">SongNav <small>- An Interactive visualization of Songs and Tags from xx</small></a>
                </div>


                <div id="navbar" class="navbar-collapse collapse">



                    <ul class="nav navbar-nav navbar-left">

                        <form class="navbar-form navbar-left" action="/" method="post" >
                            <div class="form-group">
                                <input type="text" class="form-control" placeholder="Song or Tag" name="query1">
                            </div>
                            <!--<button type="submit" class="btn btn-default">Submit</button>-->

                            <div class="form-group">
                                <input type="text" class="form-control" placeholder="Song or Tag" name="query2">
                            </div>
                            <button type="button" class="btn btn-default">Submit</button>

                        </form>




                        <li id="map_mode" class="dropdown">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
                                <span class="mode">Mode: </span><span data-bind="label" class="dropdown-label"> test </span>&nbsp;<span class="caret"></span>
                            </a>
                            <ul class="dropdown-menu" role="menu">
                                <li><a href="#" class="mode" data-mode="test1">test1</a></li>
                                <li><a href="#" class="mode" data-mode="test2">test2</a></li>
                                <li><a href="#" class="mode" data-mode="test3">test3</a></li>
                                <li><a href="#" class="mode" data-mode="test4">test4</a></li>
                                <li><a href="#" class="mode" data-mode="test5">test5</a></li>
                            </ul>
                        </li>
                    </ul>



                    <ul class="nav navbar-nav navbar-right">
                        <li><a href="#" id="button_about">About</a></li>

                    </ul>

                </div><!-- /.navbar-collapse -->
            </div>


        </nav>



        <div id="container" style="width:100%; height:100%; ">
        <script>

            if (!Detector.webgl) Detector.addGetWebGLMessage();

            var container, stats;
            var camera, scene, renderer, controls;
            var points;

            var renderer, scene, camera, stats;

            var uniforms, PARTICLE_SIZE = 10000;
            var raycaster, intersects;
            var mouse, INTERSECTED;

            init();
            animate();

            function init() {

                container = document.getElementById( 'container' );

                // perspectiveCamera(fov: Camera frustum vertical field of view,
                //                   aspect: Camera frustum aspect ratio
                //                   near: Camera frustum near plane. (얼마나 가까이갈수있는지 == 깊게 들어가는지)
                //                   far: Camera frustum far plane. (얼마나 멀리 당겨질수있는가)
                //        camera = new THREE.PerspectiveCamera( 27, window.innerWidth / window.innerHeight, 0.1, 200000 );
                //        camera.position.z = 2750;

                camera = new THREE.PerspectiveCamera( 45, window.innerWidth / window.innerHeight, 0.1, 10000 );
                camera.position.z = 250;


                controls = new THREE.TrackballControls(camera);
                controls.rotateSpeed = 1.0;
                controls.zoomSpeed = 1.2;
                controls.panSpeed = 0.8;

                controls.noZoom = false;
                controls.noPan = false;

                controls.staticMoving = true;
                controls.dynamicDampingFactor = 0.3;

                controls.keys = [ 65, 83, 68 ];

                controls.addEventListener( 'change', render );


                scene = new THREE.Scene();
                //        scene.fog = new THREE.Fog( 0x050505, 2000, 3500 );

                //

                var boxGeometry = new THREE.BoxGeometry(200, 200, 200, 16, 16, 16);
                var vertices = boxGeometry.vertices;

                console.log(vertices);

                var positions = new Float32Array(vertices.length * 3);
                var colors = new Float32Array(vertices.length * 3);
                var sizes = new Float32Array(vertices.length);
                var indices = new Uint32Array(vertices.length);

                var vertex;
                var color = new THREE.Color();

                for (var i =0; i< vertices.length; i++){
                    vertex = vertices[i];
                    vertex.toArray(positions, i*3);

                    color.setHSL( 0.01 + 0.1 * ( i / vertices.length ), 1.0, 0.5 );
                    color.toArray(colors, i*3);

                    sizes[i] = 15;
                    indices[i] = i;
                }

                var geometry = new THREE.BufferGeometry();
                geometry.addAttribute( 'position', new THREE.BufferAttribute( positions, 3 ) );
                geometry.addAttribute( 'customColor', new THREE.BufferAttribute( colors, 3 ) );
                geometry.addAttribute( 'size', new THREE.BufferAttribute( sizes, 1 ) );
                geometry.addAttribute('id', new THREE.BufferAttribute(indices, 1));
                //        geometry.setIndex(new THREE.BufferAttribute(indices, 1));

                /*

                 var interleaved_buffer_float32 = new Float32Array( PARTICLE_SIZE * 4 );
                 var interleaved_buffer_uint8 = new Uint8Array( interleaved_buffer_float32.buffer );

                 var n = 10000, n2 = n / 2; // particles spread in the cube

                 for ( var i = 0; i < interleaved_buffer_float32.length; i += 4 ) {

                 // positions

                 var x = Math.random() * n - n2;
                 var y = Math.random() * n - n2;
                 var z = Math.random() * n - n2;

                 interleaved_buffer_float32[ i + 0 ] = x;
                 interleaved_buffer_float32[ i + 1 ] = y;
                 interleaved_buffer_float32[ i + 2 ] = z;

                 // colors

                 var vx = ( x / n ) + 0.5;
                 var vy = ( y / n ) + 0.5;
                 var vz = ( z / n ) + 0.5;

                 color.setRGB( vx, vy, vz );

                 var j = ( i + 3 ) * 4;

                 interleaved_buffer_uint8[ j + 0 ] = color.r * 255;
                 interleaved_buffer_uint8[ j + 1 ] = color.g * 255;
                 interleaved_buffer_uint8[ j + 2 ] = color.b * 255;
                 interleaved_buffer_uint8[ j + 3 ] = 0;

                 }

                 var indices = new Uint32Array(PARTICLE_SIZE);
                 var sizes = new Uint32Array(PARTICLE_SIZE);
                 for(var i=0; i<indices.length; i++){
                 indices[i] = i;
                 sizes[i] = 2;
                 }


                 console.log(indices);

                 var ibp = new THREE.InterleavedBuffer( interleaved_buffer_float32, 4 );
                 var ibc = new THREE.InterleavedBuffer( interleaved_buffer_uint8, 16 );
                 //        var ibp = interleaved_buffer_float32;
                 //        var ibc = interleaved_buffer_uint8;

                 console.log(ibp);
                 console.log(ibc);

                 //        geometry.addAttribute( 'position', new THREE.BufferAttribute( ibp, 3, 0, false ) );
                 //        geometry.addAttribute( 'color', new THREE.BufferAttribute( ibc, 3, 12, true ) );
                 geometry.addAttribute( 'position', new THREE.InterleavedBufferAttribute( ibp, 3, 0, false ) );
                 geometry.addAttribute( 'color', new THREE.InterleavedBufferAttribute( ibc, 3, 12, true ) );

                 geometry.addAttribute( 'size', new THREE.BufferAttribute( sizes, 1));
                 // add index attributes(itemSize: 1)
                 //        geometry.addAttribute( 'index', new THREE.BufferAttribute(indices, 1));
                 geometry.setIndex(new THREE.BufferAttribute(indices, 1));
                 // geometry.computeBoundingSphere();

                 //
                 console.log(geometry);
                 */

                //        var material = new THREE.PointsMaterial( { size: 15, vertexColors: THREE.VertexColors } );

                console.log(geometry);

                //        var material = new THREE.PointsMaterial( { vertexColors: THREE.VertexColors } );

                var material = new THREE.ShaderMaterial( {

                    uniforms: {
                        color:   { value: new THREE.Color( 0xffffff ) },
                        texture: { value: new THREE.TextureLoader().load( "img/disc.png" ) }
                    },
                    vertexShader: document.getElementById( 'vertexshader' ).textContent,
                    fragmentShader: document.getElementById( 'fragmentshader' ).textContent,

                    alphaTest: 0.9

                } );

                points = new THREE.Points( geometry, material );
                scene.add( points );

                //

                renderer = new THREE.WebGLRenderer( { antialias: false } );
                //        renderer.setClearColor( scene.fog.color );
                renderer.setPixelRatio( window.devicePixelRatio );
                renderer.setSize( window.innerWidth, window.innerHeight );
                container.appendChild( renderer.domElement );





                raycaster = new THREE.Raycaster();
                mouse = new THREE.Vector2();

                //        stats = new Stats();
                //        container.appendChild( stats.dom );

                window.addEventListener( 'resize', onWindowResize, false );
                document.addEventListener( 'mousemove', onDocumentMouseMove, false );

            }

            function createSearchBox(){
                searchBox = document.createElement('input');
                searchBox.className = "form-control";
                searchBox.style.position = "absolute";
                searchBox.style.width = "100px"
                searchBox.style.top = "5%";
                searchBox.style.left = "5%";


                searchBox.setAttribute("type", "text");


                container.appendChild(searchBox);
            }

            function onDocumentMouseMove( event ) {

//                event.preventDefault();

                mouse.x = ( event.clientX / window.innerWidth ) * 2 - 1;
                mouse.y = - ( event.clientY / window.innerHeight ) * 2 + 1;

            }

            function onWindowResize() {

                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();

                renderer.setSize( window.innerWidth, window.innerHeight );

                controls.handleResize();


            }

            function animate() {

                requestAnimationFrame( animate );
                controls.update();
                render();
                //        stats.update();

            }

            function render() {


                // rotate points entirely
                //        var time = Date.now() * 0.001;
                //
                //        points.rotation.x = time * 0.25;
                //        points.rotation.y = time * 0.5;
                var geometry = points.geometry;
                var attributes = geometry.attributes;

                raycaster.setFromCamera( mouse, camera );

                intersects = raycaster.intersectObject( points );

                if ( intersects.length > 0 ) {

                    if ( INTERSECTED != intersects[ 0 ].index ) {
                        // initial size is 15
                        attributes.size.array[ INTERSECTED ] = 15;

                        INTERSECTED = intersects[ 0 ].index;

                        attributes.size.array[ INTERSECTED ] = 15 * 1.25;
                        attributes.size.needsUpdate = true;

                    }

                } else if ( INTERSECTED !== null ) {

                    attributes.size.array[ INTERSECTED ] = 15;
                    attributes.size.needsUpdate = true;
                    INTERSECTED = null;

                }

                renderer.render( scene, camera );

            }


        </script>

    </div>


<script>

    // search box event.

    $("input.form-control").click(function () {

        $(this).focus();
    });

    $(".btn.btn-default").click(function () {

        var inputs = document.getElementsByClassName("form-control");

        var query = [];
        for(var i =0; i<inputs.length; i++){
            query.push(inputs[i].value)
        }

        console.log(query);


        $.ajax({
            url: 'http://localhost:7777/songParser',
            dataType: 'json',
            type: 'POST',
            data: {'msg': query},
            success: function (result) {
                console.log("result: " + result.msg);
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                alert("Status: " + textStatus); alert("Error: " + errorThrown);
            }

        });

    });


</script>






</body>
</html>